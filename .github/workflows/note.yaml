name: Daily AI Engineer Note (Gemini with Rotation)

on:
  schedule:
    - cron: "0 9 * * *" # every day at 9:00 UTC
  workflow_dispatch:

jobs:
  post-note:
    runs-on: ubuntu-latest
    steps:
      - name: Choose Prompt by Weekday
        id: prompt
        run: |
          DOW=$(date +%u)
          case $DOW in
            1) PROMPT="Imagine you‚Äôre mentoring a junior developer. Share one concise, practical piece of software engineering advice that is timeless and easy to apply." ;;
            2) PROMPT="Write a short note about distributed systems or scalability that highlights a simple but powerful lesson for engineers." ;;
            3) PROMPT="Share a productivity or clean code tip that can help engineers write better code every day." ;;
            4) PROMPT="Write a concise reflection on DevOps, infrastructure, or automation that would inspire engineers to build resilient systems." ;;
            5) PROMPT="Write a short AI/ML engineering insight ‚Äî practical and inspiring, focused on real-world software applications." ;;
            6) PROMPT="Share a short security or CTF-inspired lesson that highlights a common pitfall and how to avoid it." ;;
            7) PROMPT="Write an encouraging note about the mindset of continuous learning and craftsmanship in software engineering." ;;
          esac

          {
            echo "prompt<<EOF"
            echo "$PROMPT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate note with Gemini
        id: generate
        run: |
          TODAY=$(date +'%B %d, %Y')

          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [
                {
                  \"parts\": [
                    {\"text\": \"You are writing an AI Engineer Note for $TODAY. ${{ steps.prompt.outputs.prompt }} Keep it under 4 sentences and without any personal information. Format should be in Telegram Markdown format!\"}
                  ]
                }
              ]
            }")

          NOTE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          {
            echo "note<<EOF"
            echo "$NOTE"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          ESCAPED_NOTE=$(echo "${{ steps.generate.outputs.note }}" | sed -E 's/([_*\[\]()~`>#+\-=|{}.!])/\\\1/g')

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üìù AI Engineer Note ‚Äì $(date +'%A, %B %d'):\n\n$ESCAPED_NOTE" \
            -d parse_mode=MarkdownV2 \
            -d disable_web_page_preview=true
